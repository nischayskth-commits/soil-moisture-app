<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Soil Moisture Predictor — Enhanced</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --card-bg: rgba(255,255,255,0.96);
      --accent: #2b9cff;
      --muted: #6b7280;
    }
    html,body { height:100%; }
    body{
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; min-height:100%;
      background: linear-gradient(180deg,#eef6ff 0%, #f6f9ff 50%, #fffaf6 100%);
      display:flex; align-items:center; justify-content:center;
      padding:40px;
      overflow-y:auto;
      position: relative;
    }

    /* Soil slideshow background (CSS animation) */
    .bg-slideshow {
      position: fixed;
      inset: 0;
      z-index: 0;
      background-size: cover;
      background-position: center;
      filter: brightness(.85);
      opacity: 0.98;
      animation: slide 20s linear infinite;
    }
    .bg-slideshow { background-image: url("images/soil1.jpg"); }
    @keyframes slide {
      0% { background-image: url("images/soil1.jpg"); }
      25% { background-image: url("images/soil2.jpg"); }
      50% { background-image: url("images/soil3.jpg"); }
      75% { background-image: url("images/soil4.jpg"); }
      100% { background-image: url("images/soil1.jpg"); }
    }

    /* floating blobs */
    .blob {
      position: fixed;
      filter: blur(70px);
      opacity: .12;
      z-index: 1;
      transform: translate3d(0,0,0);
      animation: floaty 12s ease-in-out infinite;
      border-radius: 50%;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    .blob.b1{ width:420px; height:420px; left:-120px; top:-80px; background: #d8f1ff; animation-duration:18s; }
    .blob.b2{ width:360px; height:360px; right:-100px; bottom:-60px; background: #ffe6f0; animation-duration:16s; }
    @keyframes floaty {
      0% { transform: translateY(0px) translateX(0px) rotate(0deg); }
      50% { transform: translateY(-30px) translateX(18px) rotate(6deg); }
      100% { transform: translateY(0px) translateX(0px) rotate(0deg); }
    }

    /* main card */
    .app-card {
      width: 100%; max-width:760px;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.10);
      padding: 28px;
      position: relative;
      z-index: 2;
      transition: transform .18s ease, box-shadow .18s ease;
      backdrop-filter: blur(4px);
    }
    .app-card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(15,23,42,0.12); }

    h1 { font-weight:700; margin-bottom:6px; font-size:22px; }
    .subtitle { color:var(--muted); font-size:14px; margin-bottom:18px; }

    label{ font-weight:600; font-size:14px; color:#233044; margin-top:12px; }
    .form-control { border-radius:10px; padding:10px 12px; }

    /* buttons */
    .btn-main{
      border-radius:10px; padding:10px 14px;
      box-shadow:none; transition:transform .12s ease;
    }
    .btn-main:active{ transform:translateY(1px) }

    /* result box styles w/ animations */
    .result {
      border-radius:12px; padding:14px; margin-top:14px;
      transition: transform .18s cubic-bezier(.2,.9,.2,1), opacity .18s;
      opacity: 0; transform: translateY(8px);
    }
    .result.show{ opacity:1; transform: translateY(0px); display:block; }

    .low { background: linear-gradient(90deg,#fff5f5,#ffdede); border-left:4px solid #ff6b6b; color:#7a0c0c; }
    .medium { background: linear-gradient(90deg,#fffaf0,#fff5cc); border-left:4px solid #f59e0b; color:#553d00; }
    .high { background: linear-gradient(90deg,#f0fff5,#dfffe7); border-left:4px solid #0ea5a3; color:#064e3b; }

    .small-muted { color:#6b7280; font-size:13px; }
    .rec-card { border-radius:10px; padding:12px; background:#ffffff; border:1px solid rgba(15,23,42,.04); margin-top:10px; }

    .icon-circle { width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#eff8ff,#e8f7ff); margin-right:10px; }

    footer { text-align:center; color:#80848f; font-size:13px; margin-top:18px; }

    .spinner-border-sm { width:18px; height:18px; border-width:2px; }

    @media (max-width:560px){
      body{ padding:18px }
      .app-card{ padding:18px }
    }

    /* image-upload error message */
    .image-error {
      color: #b91c1c;
      background: #fff1f2;
      border-left:4px solid #fca5a5;
      padding:8px 12px;
      border-radius:8px;
      margin-top:8px;
      display:none;
    }
  </style>
</head>
<body>

  <!-- background & blobs -->
  <div class="bg-slideshow" aria-hidden="true"></div>
  <div class="blob b1" aria-hidden="true"></div>
  <div class="blob b2" aria-hidden="true"></div>

  <div class="app-card container">
    <div class="row">
      <div class="col-12 text-center">
        <h1>?? Soil Moisture Predictor</h1>
        <div class="subtitle">Predict soil moisture & get recommendations — crops, fertilizer & actions</div>
      </div>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-12 text-center mb-2">
        <button class="btn btn-info btn-main w-100" id="btn-weather" title="Auto-fill weather using your location">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="vertical-align:middle; margin-right:8px" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20 16.58A5 5 0 0 0 18 6h-1.26A7 7 0 0 0 5 9a5 5 0 0 0 1 9h14z"/><circle cx="7" cy="18" r="1"/><circle cx="11" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>
          Auto-Fill Weather Data
        </button>
      </div>

      <div class="col-md-6">
        <label>Temperature (°C)</label>
        <input id="temperature" class="form-control" type="number" value="25">
      </div>
      <div class="col-md-6">
        <label>Humidity (%)</label>
        <input id="humidity" class="form-control" type="number" value="60">
      </div>

      <div class="col-md-6">
        <label>Rainfall (mm)</label>
        <input id="rainfall" class="form-control" type="number" value="4">
      </div>
      <div class="col-md-6">
        <label>Soil Type (Manual)</label>
        <select id="soil_type" class="form-control">
          <option value="0">Sandy</option>
          <option value="1" selected>Loam</option>
          <option value="2">Clay</option>
        </select>
      </div>

      <!-- MAIN predict button (NO image logic here) -->
      <div class="col-12 text-center mt-2">
        <button id="btn-predict" class="btn btn-primary btn-main w-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="vertical-align:middle; margin-right:8px" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M21 21l-4.35-4.35"/><circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
          Predict Moisture
        </button>
      </div>

      <!-- results -->
      <div class="col-12">
        <div id="moistBox" class="result low" style="display:none;">
          <div style="display:flex; align-items:center;">
            <div class="icon-circle" id="icon-tint">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#0077cc" aria-hidden="true"><path d="M12 2s-6 7.5-6 11a6 6 0 1 0 12 0c0-3.5-6-11-6-11z"/></svg>
            </div>
            <div>
              <div id="moistText" style="font-weight:700; font-size:16px;">Moisture: --</div>
              <div class="small-muted" id="catText">Category: --</div>
            </div>
          </div>
        </div>

        <div id="actionCard" class="rec-card" style="display:none;">
          <div style="display:flex; align-items:flex-start;">
            <div class="me-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="#2b9cff" aria-hidden="true"><path d="M2 12c3 0 3 3 6 3s3-3 6-3 3 3 6 3v6H2v-6z"/></svg>
            </div>
            <div>
              <div id="actionText" style="font-weight:600;">Recommended action will show here.</div>
              <div class="small-muted" id="explainText">Brief explanation of why.</div>
            </div>
          </div>
        </div>

        <div id="recGrid" class="mt-3" style="display:none;">
          <div class="row g-2">
            <div class="col-md-6">
              <div class="rec-card">
                <div style="display:flex; align-items:center;">
                  <div class="me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="#16a34a" aria-hidden="true"><path d="M12 2s-1.5 4-3 6c-1.6 2.2-3 3-3 6 0 3 3 4 6 4s6-1 6-4c0-3-1.4-3.8-3-6C13.5 6 12 2 12 2z"/></svg>
                  </div>
                  <div>
                    <div style="font-weight:700">Recommended Crops</div>
                    <div class="small-muted" id="cropList">--</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="rec-card">
                <div style="display:flex; align-items:center;">
                  <div class="me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="#c084fc" aria-hidden="true"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8 4a7.9 7.9 0 0 0-.2-2l2.1-1.6-2-3.4-2.6 1a8 8 0 0 0-1.7-1L14 2h-4l-.6 2.1c-.6.2-1.2.6-1.7 1L4.1 4.2 2 7.6 4.1 9.2c-.1.6-.1 1.2 0 2L2 13v4l2 .6c.2.7.6 1.3 1.1 1.9l-1 2 3.4 2 1.1-1.6c.6.2 1.2.3 1.8.3s1.2-.1 1.8-.3L16 22l1-2c.5-.6.9-1.2 1.1-1.9l2-.6v-4z"/></svg>
                  </div>
                  <div>
                    <div style="font-weight:700">Fertilizer Tips</div>
                    <div class="small-muted" id="fertList">--</div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <footer id="siteFooter" style="margin-top:18px;">
          Made with <span id="heart" style="color:#e25555">?</span> for Smart Farming
        </footer>
      </div>
    </div>

    <!-- SEPARATE Image uploader area -->
    <div class="row mt-4">
      <div class="col-12">
        <label>Upload Soil Photo (image-only) — use this for image-based prediction</label>
        <input id="soilImageSeparate" class="form-control" type="file" accept="image/*">
        <div class="image-error" id="imgError">Photo unsuitable — please upload a clear soil image (JPG/PNG).</div>
      </div>
      <div class="col-12 text-center mt-2">
        <button id="btn-predict-image" class="btn btn-outline-primary btn-main w-50">
          Predict from Image
        </button>
      </div>
    </div>

  </div>

<script>
/* API detection */
const RENDER_BACKEND = "https://soil-moisture-backend-r7m2.onrender.com";
const API = (location.hostname.includes("github.io") || location.hostname.includes("render.com")) ? RENDER_BACKEND : "http://127.0.0.1:8000";

/* helpers */
function categoryTag(val) {
  if (val < 15) return "Low (Dry)";
  if (val < 30) return "Medium (Optimal)";
  return "High (Wet)";
}
function recommendCrops(category, soil_type) {
  let crops = [];
  if (category.includes("Low")) {
    crops = ["Millet", "Sorghum (Jowar)", "Pearl millet", "Groundnut", "Chickpea"];
  } else if (category.includes("Medium")) {
    crops = ["Tomato", "Okra", "Maize", "Wheat", "Leafy vegetables"];
  } else {
    crops = ["Rice", "Taro", "Sugarcane", "Paddy varieties", "Lotus"];
  }
  if (soil_type == 0) crops = crops.slice(0,4);
  if (soil_type == 2) crops = crops.slice(0,5);
  return crops.join(", ");
}
function recommendFertilizer(soil_type, moisture_cat) {
  if (soil_type == 0) {
    return "Sandy: add organic matter (compost), slow-release NPK, mulch to retain moisture.";
  }
  if (soil_type == 1) {
    return "Loam: balanced NPK per crop; add compost seasonally to maintain structure.";
  }
  if (moisture_cat.includes("High")) {
    return "Clay & wet: improve drainage, consider gypsum; reduce heavy fertilizer after rain.";
  }
  return "Clay: add organic matter and consider gypsum to improve structure.";
}
function setResultStyle(className) {
  const box = document.getElementById("moistBox");
  box.classList.remove("low","medium","high","show");
  box.className = "result";
  box.classList.add(className);
  box.classList.add("show");
  box.style.display = "block";
}
function hideResults() {
  document.getElementById("moistBox").style.display = "none";
  document.getElementById("actionCard").style.display = "none";
  document.getElementById("recGrid").style.display = "none";
}

/* WEATHER autofill (same as before) */
document.getElementById("btn-weather").addEventListener("click", async () => {
  if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
  const btn = document.getElementById("btn-weather");
  btn.disabled = true; btn.innerHTML = 'Fetching…';
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relativehumidity_2m,precipitation`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("Weather fetch failed");
      const j = await r.json();
      const temp = j.current_weather?.temperature ?? parseFloat(document.getElementById("temperature").value);
      document.getElementById("temperature").value = temp;
      let humidity = 60;
      if (j.hourly && j.hourly.relativehumidity_2m && j.hourly.time) {
        humidity = j.hourly.relativehumidity_2m[0] ?? humidity;
      }
      document.getElementById("humidity").value = humidity;
      let rain = 0;
      if (j.hourly && j.hourly.precipitation) rain = j.hourly.precipitation[0] ?? 0;
      document.getElementById("rainfall").value = Math.round(rain * 10) / 10;
    } catch(e){
      console.warn(e);
      alert("Weather fetch failed — using defaults.");
    } finally {
      btn.disabled = false; btn.innerHTML = 'Auto-Fill Weather Data';
    }
  }, err => {
    alert("Location permission needed for weather autofill.");
    btn.disabled = false; btn.innerHTML = 'Auto-Fill Weather Data';
  });
});

/* MAIN predict (numeric input only) */
document.getElementById("btn-predict").addEventListener("click", async () => {
  hideResults();
  const btn = document.getElementById("btn-predict");
  btn.disabled = true; btn.innerHTML = 'Predicting...';

  try {
    const body = {
      temperature: parseFloat(document.getElementById("temperature").value) || 0,
      humidity: parseFloat(document.getElementById("humidity").value) || 0,
      rainfall: parseFloat(document.getElementById("rainfall").value) || 0,
      soil_type: parseInt(document.getElementById("soil_type").value) || 1
    };

    const resp = await fetch(`${API}/predict`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if (!resp.ok) {
      const text = await resp.text();
      throw new Error("Server error: " + text);
    }
    const data = await resp.json();
    const moist = (data && data.moisture !== undefined) ? Number(data.moisture) : NaN;
    const moistureText = Number.isFinite(moist) ? `${moist.toFixed(2)}%` : (data.moisture ?? "--");
    const cat = (data && data.category) ? data.category : (Number.isFinite(moist) ? categoryTag(moist) : "Unknown");
    document.getElementById("moistText").innerHTML = `Moisture: <span style="color:inherit; font-weight:700">${moistureText}</span>`;
    document.getElementById("catText").innerText = `Category: ${cat}`;
    if (cat.includes("Low")) setResultStyle("low");
    else if (cat.includes("Medium")) setResultStyle("medium");
    else setResultStyle("high");

    // action + explanation
    let actionText = "", explain = "";
    if (Number.isFinite(moist) && (moist < 12 || (cat.includes("Low") && body.rainfall < 5))) {
      actionText = "?? Soil is dry. Irrigate soon (small, frequent doses) and apply mulch to retain moisture.";
      explain = data.explanation || "Low predicted moisture with little recent rainfall — irrigate and mulch.";
    } else if (cat.includes("Medium")) {
      actionText = "?? Moisture is optimal. Monitor regularly and follow crop schedule.";
      explain = data.explanation || "Conditions are within the model's optimal range.";
    } else {
      if (body.rainfall > 10) {
        actionText = "? Soil is wet after rain. Pause irrigation and check drainage.";
        explain = data.explanation || "High moisture and recent rainfall — avoid over-irrigation.";
      } else {
        actionText = "? Soil is wet. Check field drains and avoid watering until it lowers.";
        explain = data.explanation || "Model predicts high moisture — verify field conditions.";
      }
    }
    document.getElementById("actionText").innerHTML = actionText;
    document.getElementById("explainText").innerText = data.explanation || explain;

    // recs:
    const crops = recommendCrops(cat, body.soil_type);
    const fert = recommendFertilizer(body.soil_type, cat);
    document.getElementById("cropList").innerText = crops;
    document.getElementById("fertList").innerText = fert;
    document.getElementById("recGrid").style.display = "block";
    document.getElementById("actionCard").style.display = "block";

  } catch (err) {
    console.error(err);
    alert("Prediction failed: " + (err.message || err));
  } finally {
    btn.disabled = false; btn.innerHTML = 'Predict Moisture';
  }
});

/* IMAGE PREDICT handler (separate) */
document.getElementById("btn-predict-image").addEventListener("click", async () => {
  // Clear any previous image error
  const imgErr = document.getElementById("imgError");
  imgErr.style.display = "none";

  const input = document.getElementById("soilImageSeparate");
  if (!input.files || input.files.length === 0) {
    imgErr.textContent = "Please choose an image file to upload.";
    imgErr.style.display = "block";
    return;
  }

  const file = input.files[0];

  // CLIENT-SIDE checks: must be image and size reasonable
  if (!file.type || !file.type.startsWith("image/")) {
    imgErr.textContent = "File is not an image. Please upload a JPG/PNG soil photo.";
    imgErr.style.display = "block";
    input.value = ""; // clear
    return;
  }
  const maxMB = 6; // adjust if you want
  if (file.size > maxMB * 1024 * 1024) {
    imgErr.textContent = `Image too large (>${maxMB}MB). Please upload a smaller photo.`;
    imgErr.style.display = "block";
    input.value = "";
    return;
  }

  const btn = document.getElementById("btn-predict-image");
  btn.disabled = true; btn.innerText = "Uploading...";
  hideResults();

  try {
    const fd = new FormData();
    fd.append("file", file);

    const upResp = await fetch(`${API}/upload`, { method: "POST", body: fd });
    if (!upResp.ok) {
      const txt = await upResp.text();
      throw new Error("Upload failed: " + txt);
    }
    const ujson = await upResp.json();

    // Expecting server to return something like { soil_type: 0 } or { error: "not_soil" }
    if (!ujson || ujson.soil_type === undefined) {
      // server says not-soil or returned nothing relevant
      imgErr.textContent = "Photo unsuitable — please upload a clear soil image (JPG/PNG).";
      imgErr.style.display = "block";
      input.value = "";
      return;
    }

    // valid soil_type -> do a prediction using that soil_type and current numerical inputs
    const soilType = parseInt(ujson.soil_type);
    document.getElementById("soil_type").value = soilType;

    // You can decide whether to use the numeric inputs or defaults here.
    const body = {
      temperature: parseFloat(document.getElementById("temperature").value) || 25,
      humidity: parseFloat(document.getElementById("humidity").value) || 60,
      rainfall: parseFloat(document.getElementById("rainfall").value) || 4,
      soil_type: soilType
    };

    // call predict
    const p = await fetch(`${API}/predict`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if (!p.ok) {
      const t = await p.text();
      throw new Error("Predict after upload failed: " + t);
    }
    const data = await p.json();

    // show results (same as main predict)
    const moist = (data && data.moisture !== undefined) ? Number(data.moisture) : NaN;
    const moistureText = Number.isFinite(moist) ? `${moist.toFixed(2)}%` : (data.moisture ?? "--");
    const cat = (data && data.category) ? data.category : (Number.isFinite(moist) ? categoryTag(moist) : "Unknown");
    document.getElementById("moistText").innerHTML = `Moisture: <span style="color:inherit; font-weight:700">${moistureText}</span>`;
    document.getElementById("catText").innerText = `Category: ${cat}`;
    if (cat.includes("Low")) setResultStyle("low");
    else if (cat.includes("Medium")) setResultStyle("medium");
    else setResultStyle("high");

    // action and text
    let actionText = "", explain = "";
    if (Number.isFinite(moist) && (moist < 12 || (cat.includes("Low") && body.rainfall < 5))) {
      actionText = "?? Soil is dry. Irrigate soon (small, frequent doses) and apply mulch to retain moisture.";
      explain = data.explanation || "Low predicted moisture with little recent rainfall — irrigate and mulch.";
    } else if (cat.includes("Medium")) {
      actionText = "?? Moisture is optimal. Monitor regularly and follow crop schedule.";
      explain = data.explanation || "Conditions are within the model's optimal range.";
    } else {
      if (body.rainfall > 10) {
        actionText = "? Soil is wet after rain. Pause irrigation and check drainage.";
        explain = data.explanation || "High moisture and recent rainfall — avoid over-irrigation.";
      } else {
        actionText = "? Soil is wet. Check field drains and avoid watering until it lowers.";
        explain = data.explanation || "Model predicts high moisture — verify field conditions.";
      }
    }
    document.getElementById("actionText").innerHTML = actionText;
    document.getElementById("explainText").innerText = data.explanation || explain;

    // recs
    document.getElementById("cropList").innerText = recommendCrops(cat, soilType);
    document.getElementById("fertList").innerText = recommendFertilizer(soilType, cat);
    document.getElementById("recGrid").style.display = "block";
    document.getElementById("actionCard").style.display = "block";

    // keep the succesful uploaded file in input? we'll clear it to avoid accidental re-submission:
    input.value = "";

  } catch (err) {
    console.error(err);
    const msg = (err.message || String(err));
    const imgErr = document.getElementById("imgError");
    imgErr.textContent = "Photo unsuitable — please upload a clear soil image (JPG/PNG).";
    imgErr.style.display = "block";
    input.value = "";
  } finally {
    btn.disabled = false; btn.innerText = 'Predict from Image';
  }
});
</script>

</body>
</html>

